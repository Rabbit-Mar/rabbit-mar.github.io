<!DOCTYPE html>
<html lang=zh>
<head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, minimum-scale=1, user-scalable=no, minimal-ui">
  <meta name="renderer" content="webkit">
  <meta http-equiv="Cache-Control" content="no-transform" />
  <meta http-equiv="Cache-Control" content="no-siteapp" />
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black">
  <meta name="format-detection" content="telephone=no,email=no,adress=no">
  <meta name="theme-color" content="#000000" />
  <!-- 强制页面在当前窗口以独立页面显示,防止别人在框架里调用页面 -->
  <meta http-equiv="window-target" content="_top" />
  
  
  <title>基于Redis分布式锁的演变及实现 | Marveal Rabbit - Coder&#39;s Blog</title>
  <meta name="description" content="对Redis实现分布式锁的总结和自我的认识，文章中借鉴了部分官网的原句，后面会有所补充">
<meta property="og:type" content="article">
<meta property="og:title" content="基于Redis分布式锁的演变及实现">
<meta property="og:url" content="https://rabbit-mar.github.io/2020/05/29/%E5%9F%BA%E4%BA%8ERedis%E5%88%86%E5%B8%83%E5%BC%8F%E9%94%81%E7%9A%84%E6%BC%94%E5%8F%98%E5%8F%8A%E5%AE%9E%E7%8E%B0/index.html">
<meta property="og:site_name" content="Marveal Rabbit">
<meta property="og:description" content="对Redis实现分布式锁的总结和自我的认识，文章中借鉴了部分官网的原句，后面会有所补充">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="https://picsum.photos/1080/400">
<meta property="article:published_time" content="2020-05-29T01:31:29.000Z">
<meta property="article:modified_time" content="2021-02-18T14:29:22.508Z">
<meta property="article:author" content="Marveal Rabbit">
<meta property="article:tag" content="Redis">
<meta property="article:tag" content="Java">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://picsum.photos/1080/400">
  <!-- Canonical links -->
  <link rel="canonical" href="https://rabbit-mar.github.io/2020/05/29/%E5%9F%BA%E4%BA%8ERedis%E5%88%86%E5%B8%83%E5%BC%8F%E9%94%81%E7%9A%84%E6%BC%94%E5%8F%98%E5%8F%8A%E5%AE%9E%E7%8E%B0/index.html">
  
    <link rel="alternate" href="/atom.xml" title="Marveal Rabbit" type="application/atom+xml">
  
  
    <link rel="icon" href="/favicon.ico" type="image/x-icon">
  
  
<link rel="stylesheet" href="/css/style.css">

  
  
    <link rel="stylesheet" href="//cdn.jsdelivr.net/npm/gitment@0.0.3/style/default.min.css">
  
  
<meta name="generator" content="Hexo 5.3.0"></head>


<body class="main-center" itemscope itemtype="http://schema.org/WebPage">
  <header class="header" itemscope itemtype="http://schema.org/WPHeader">
  <div class="slimContent">
    <div class="navbar-header">
      
      
      <div class="profile-block text-center">
        <a id="avatar" href="https://github.com/Rabbit-Mar" target="_blank">
          <img class="img-circle" src="/images/avatar.jpg" width="200" height="200">
        </a>
        <h2 id="name" class="hidden-xs hidden-sm">Marveal Rabbit</h2>
        <h3 id="title" class="hidden-xs hidden-sm hidden-md">Programming Lover &amp; Coder</h3>
        <small id="location" class="text-muted hidden-xs hidden-sm"><i class="icon icon-map-marker"></i> Hangzhou, China</small>
      </div>
      
      <div class="search" id="search-form-wrap">

    <form class="search-form sidebar-form">
        <div class="input-group">
            <input type="text" class="search-form-input form-control" placeholder="搜索" />
            <span class="input-group-btn">
                <button type="submit" class="search-form-submit btn btn-flat" onclick="return false;"><i class="icon icon-search"></i></button>
            </span>
        </div>
    </form>
    <div class="ins-search">
  <div class="ins-search-mask"></div>
  <div class="ins-search-container">
    <div class="ins-input-wrapper">
      <input type="text" class="ins-search-input" placeholder="想要查找什么..." x-webkit-speech />
      <button type="button" class="close ins-close ins-selectable" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">×</span></button>
    </div>
    <div class="ins-section-wrapper">
      <div class="ins-section-container"></div>
    </div>
  </div>
</div>


</div>
      <button class="navbar-toggle collapsed" type="button" data-toggle="collapse" data-target="#main-navbar" aria-controls="main-navbar" aria-expanded="false">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
    </div>
    <nav id="main-navbar" class="collapse navbar-collapse" itemscope itemtype="http://schema.org/SiteNavigationElement" role="navigation">
      <ul class="nav navbar-nav main-nav ">
        
        
        <li class="menu-item menu-item-home">
          <a href="/.">
            
            <i class="icon icon-home-fill"></i>
            
            <span class="menu-title">首页</span>
          </a>
        </li>
        
        
        <li class="menu-item menu-item-archives">
          <a href="/archives">
            
            <i class="icon icon-archives-fill"></i>
            
            <span class="menu-title">归档</span>
          </a>
        </li>
        
        
        <li class="menu-item menu-item-tags">
          <a href="/tags">
            
            <i class="icon icon-tags"></i>
            
            <span class="menu-title">标签</span>
          </a>
        </li>
        
        
        <li class="menu-item menu-item-about">
          <a href="/about">
            
            <i class="icon icon-cup-fill"></i>
            
            <span class="menu-title">关于</span>
          </a>
        </li>
        
      </ul>
      
	
    <ul class="social-links">
    	
        <li><a href="https://github.com/Rabbit-Mar" target="_blank" title="Github" data-toggle=tooltip data-placement=top><i class="icon icon-github"></i></a></li>
        
        <li><a href="https://gitee.com/marveal_admin" target="_blank" title="Gitee" data-toggle=tooltip data-placement=top><i class="icon icon-gitee"></i></a></li>
        
        <li><a href="https://blog.csdn.net/weixin_43260474" target="_blank" title="Code" data-toggle=tooltip data-placement=top><i class="icon icon-code"></i></a></li>
        
        <li><a href="/atom.xml" target="_blank" title="Rss" data-toggle=tooltip data-placement=top><i class="icon icon-rss"></i></a></li>
        
    </ul>

    </nav>
  </div>
</header>

  
    <aside class="sidebar" itemscope itemtype="http://schema.org/WPSideBar">
  <div class="slimContent">
    
      <div class="widget">
    <h3 class="widget-title">公告</h3>
    <div class="widget-body">
        <div id="board">
            <div class="content">
                <p>欢迎来到Marveal Rabbit的个人博客网站</p>
            </div>
        </div>
    </div>
</div>

    
      
  <div class="widget">
    <h3 class="widget-title">标签</h3>
    <div class="widget-body">
      <ul class="tag-list" itemprop="keywords"><li class="tag-list-item"><a class="tag-list-link" href="/tags/ElasticSearch/" rel="tag">ElasticSearch</a><span class="tag-list-count">5</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Gradle/" rel="tag">Gradle</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/JVM/" rel="tag">JVM</a><span class="tag-list-count">3</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Java/" rel="tag">Java</a><span class="tag-list-count">18</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Kafka/" rel="tag">Kafka</a><span class="tag-list-count">3</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/LeetCode/" rel="tag">LeetCode</a><span class="tag-list-count">33</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Nginx/" rel="tag">Nginx</a><span class="tag-list-count">8</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/RabbitMQ/" rel="tag">RabbitMQ</a><span class="tag-list-count">2</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Redis/" rel="tag">Redis</a><span class="tag-list-count">10</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/SpringBoot/" rel="tag">SpringBoot</a><span class="tag-list-count">5</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/mycat/" rel="tag">mycat</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/sharding-jdbc/" rel="tag">sharding-jdbc</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E6%96%87%E4%BB%B6%E7%B3%BB%E7%BB%9F/" rel="tag">文件系统</a><span class="tag-list-count">1</span></li></ul>
    </div>
  </div>


    
      
  <div class="widget">
    <h3 class="widget-title">归档</h3>
    <div class="widget-body">
      <ul class="archive-list"><li class="archive-list-item"><a class="archive-list-link" href="/archives/2021/02/">二月 2021</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2020/12/">十二月 2020</a><span class="archive-list-count">7</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2020/11/">十一月 2020</a><span class="archive-list-count">14</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2020/10/">十月 2020</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2020/09/">九月 2020</a><span class="archive-list-count">3</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2020/07/">七月 2020</a><span class="archive-list-count">9</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2020/06/">六月 2020</a><span class="archive-list-count">5</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2020/05/">五月 2020</a><span class="archive-list-count">34</span></li></ul>
    </div>
  </div>


    
      
<div class="widget">
  <h3 class="widget-title">最新文章</h3>
  <div class="widget-body">
    <ul class="recent-post-list list-unstyled no-thumbnail">
      
      <li>
        
        <div class="item-inner">
          <p class="item-title">
            <a href="/2021/02/19/Kafka%E5%AE%98%E7%BD%91%E7%BF%BB%E8%AF%91%E2%80%94%E2%80%94%E8%B5%B7%E6%AD%A5/"
              class="title">Kafka官网翻译——起步</a>
          </p>
          <p class="item-date">
            <time datetime="2021-02-19T03:18:08.000Z" itemprop="datePublished">2021-02-19</time>
          </p>
        </div>
      </li>
      
      <li>
        
        <div class="item-inner">
          <p class="item-title">
            <a href="/2020/12/23/%E5%88%86%E5%BA%93%E5%88%86%E8%A1%A8%E4%B9%8Bsharding-jdbc&mycat/"
              class="title">分库分表之sharding-jdbc&amp;mycat</a>
          </p>
          <p class="item-date">
            <time datetime="2020-12-22T20:00:08.000Z" itemprop="datePublished">2020-12-23</time>
          </p>
        </div>
      </li>
      
      <li>
        
        <div class="item-inner">
          <p class="item-title">
            <a href="/2020/12/11/Redis%E5%AD%A6%E4%B9%A0%E4%B9%8B%E8%B7%AF%EF%BC%88%E4%BA%94%EF%BC%89%E2%80%94%E2%80%94-%E9%9B%86%E7%BE%A4%E6%9E%B6%E6%9E%84/"
              class="title">Redis学习之路（五）—— 集群架构</a>
          </p>
          <p class="item-date">
            <time datetime="2020-12-11T00:02:55.000Z" itemprop="datePublished">2020-12-11</time>
          </p>
        </div>
      </li>
      
      <li>
        
        <div class="item-inner">
          <p class="item-title">
            <a href="/2020/12/11/Kafka-%E5%AD%A6%E4%B9%A0%E4%B9%8B%E8%B7%AF%EF%BC%88%E4%BA%8C%EF%BC%89/"
              class="title">Kafka 学习之路（二）</a>
          </p>
          <p class="item-date">
            <time datetime="2020-12-10T23:56:18.000Z" itemprop="datePublished">2020-12-11</time>
          </p>
        </div>
      </li>
      
      <li>
        
        <div class="item-inner">
          <p class="item-title">
            <a href="/2020/12/11/Kafka-%E5%AD%A6%E4%B9%A0%E4%B9%8B%E8%B7%AF%EF%BC%88%E4%B8%80%EF%BC%89/"
              class="title">Kafka 学习之路（一）</a>
          </p>
          <p class="item-date">
            <time datetime="2020-12-10T23:54:03.000Z" itemprop="datePublished">2020-12-11</time>
          </p>
        </div>
      </li>
      
    </ul>
  </div>
</div>

    
  </div>
</aside>

  
  
<main class="main" role="main">
  <div class="content">
  <article id="post-基于Redis分布式锁的演变及实现" class="article article-type-post" itemscope
    itemtype="http://schema.org/BlogPosting">
    
<div class="article-gallery">
  <div class="article-gallery-photos">
    
      <a class="article-gallery-img fancybox" target="_blank" href="https://picsum.photos/1080/400" rel="gallery_cklc2caaj00531q028olt0w1m noopener">
        <img src="https://picsum.photos/1080/400" itemprop="image">
      </a>
    
  </div>
</div>

    <div class="article-header">
      
      
  
    <h1 class="article-title" itemprop="name">
      基于Redis分布式锁的演变及实现
    </h1>
  

      
      <div class="article-meta">
        <span class="article-date">
    <i class="icon icon-calendar-check"></i>
	<a href="/2020/05/29/%E5%9F%BA%E4%BA%8ERedis%E5%88%86%E5%B8%83%E5%BC%8F%E9%94%81%E7%9A%84%E6%BC%94%E5%8F%98%E5%8F%8A%E5%AE%9E%E7%8E%B0/" class="article-date">
	  <time datetime="2020-05-29T01:31:29.000Z" itemprop="datePublished">2020年05月29日09时</time>
	</a>
</span>
        
  <span class="article-tag">
    <i class="icon icon-tags"></i>
	<a class="article-tag-link-link" href="/tags/Java/" rel="tag">Java</a>, <a class="article-tag-link-link" href="/tags/Redis/" rel="tag">Redis</a>
  </span>


        
	<span class="article-read hidden-xs">
	    <i class="icon icon-eye-fill" aria-hidden="true"></i>
	    <span id="busuanzi_container_page_pv">
			<span id="busuanzi_value_page_pv">0</span>
		</span>
	</span>

        

<span class="post-wordcount hidden-xs" itemprop="wordCount"><i
		class="icon icon-search"></i>&nbsp;字数统计:
	3.9k(字)</span>


<span class="post-readcount hidden-xs" itemprop="timeRequired"><i
		class="icon icon-clock"></i>&nbsp;阅读时长:
	17(分)</span>


        <span class="post-comment"><i class="icon icon-comment"></i> <a href="/2020/05/29/%E5%9F%BA%E4%BA%8ERedis%E5%88%86%E5%B8%83%E5%BC%8F%E9%94%81%E7%9A%84%E6%BC%94%E5%8F%98%E5%8F%8A%E5%AE%9E%E7%8E%B0/#comments"
            class="article-comment-link">评论</a></span>
      </div>
    </div>
    <div class="article-entry marked-body" itemprop="articleBody">
      
      <h1 id="基于Redis分布式锁的演变及实现"><a href="#基于Redis分布式锁的演变及实现" class="headerlink" title="基于Redis分布式锁的演变及实现"></a>基于Redis分布式锁的演变及实现</h1><p>实现锁必须满足三个特性：①互斥； ②共享；③多任务；  </p>
<blockquote>
<p>即多个用户不能同时访问同一个共享资源  </p>
</blockquote>
<p>redis分布式锁的实现关键在于setnx命令，其语义为只在键 <code>key</code> 不存在的情况下， 将键 <code>key</code> 的值设置为 <code>value</code> ，若键 <code>key</code> 已经存在， 则 <code>SETNX</code> 命令不做任何动作。  </p>
<h2 id="第一轮演进"><a href="#第一轮演进" class="headerlink" title="第一轮演进"></a>第一轮演进</h2><p>通过setnx就可以画出一个简单的分布式锁雏形。当客户端执行业务之前，先去redis中设置一把锁，当下一个线程来访问时，也去Redis中setnx；但是由于第一次设置的锁并没有释放，所以第二线程会访问失败无法执行业务代码。直到第一个线程删除锁。  </p>
<p><img src="http://img.marvr.top/upload/images/2020/05/29/b0625c14-65dc-4b70-908f-b05936aca082.png" alt="1590647319387"></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> String <span class="title">main</span><span class="params">()</span></span>&#123;</span><br><span class="line">	String lockKey = <span class="string">&quot;lockKey&quot;</span>;</span><br><span class="line">	Boolean lock = template.opsForValue().setIfAbsent(lockKey, <span class="string">&quot;123&quot;</span>);</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> (lock != <span class="keyword">null</span> &amp;&amp; !lock) &#123; <span class="comment">// 加锁失败</span></span><br><span class="line">		<span class="keyword">return</span> <span class="string">&quot;error&quot;</span>;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="comment">// doSomething</span></span><br><span class="line">	System.out.println(<span class="string">&quot;doSomething&quot;</span>);</span><br><span class="line"></span><br><span class="line">	template.delete(lockKey);   <span class="comment">// 删除锁</span></span><br><span class="line">	<span class="keyword">return</span> <span class="string">&quot;success&quot;</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="第二轮演进"><a href="#第二轮演进" class="headerlink" title="第二轮演进"></a>第二轮演进</h2><p>根据第一轮的模型，思考有什么缺点:  </p>
<ul>
<li>如果说第一个线程在执行业务代码的时候出现了异常，直接退出程序，没有删除锁，那么就会形成死锁，其他线程无法再次加锁  </li>
</ul>
<p>解决方案:  </p>
<ul>
<li>给锁加上过期时间，当超过时间redis就自动删除key  </li>
</ul>
<p><img src="http://img.marvr.top/upload/images/2020/05/29/264639d3-400c-4842-9be4-397ac9274943.png" alt="1590648366276"></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">template.opsForValue().setIfAbsent(lockKey, <span class="string">&quot;123&quot;</span>, <span class="number">10</span>, TimeUnit.SECONDS);</span><br></pre></td></tr></table></figure>
<h2 id="第三轮演进"><a href="#第三轮演进" class="headerlink" title="第三轮演进"></a>第三轮演进</h2><p>根据第二轮模型，思考其问题:  </p>
<ul>
<li>当多个线程访问时，如果第一个线程执行远程调用的时候花费了11s，超出了预设的过期时间，那么在第10秒的时候Redis就已经将线程1创建的key删除，线程2就会创建锁；但是在第11秒时，Redis删除key，此时的key为线程2的key；那么此时锁的互斥性被破坏，使得锁失效。  </li>
</ul>
<p><img src="http://img.marvr.top/upload/images/2020/05/29/c6251c76-e869-44f6-ba52-cf7f1be3f0b7.png" alt="1590649275429"></p>
<p>解决方案:</p>
<ul>
<li>给每个线程设置唯一标识，删除key时先判断是否为唯一标识，再删除；这样能解决删除同一个key的问题。</li>
<li>开一个子线程设置一个定时器，当过去时间超过预设的2/3时，重新设置时间。例如规定的阈值为10s，那么每三秒检测redis中的key，如果key还存在就再延长2/3为6秒。</li>
</ul>
<p><img src="http://img.marvr.top/upload/images/2020/05/29/a733546f-c25f-411c-9183-a35c7355982f.png" alt="1590657064256"></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> String <span class="title">main</span><span class="params">()</span></span>&#123;</span><br><span class="line">	String lockKey = <span class="string">&quot;lockKey&quot;</span>;</span><br><span class="line">	String randId = UUID.randomUUID().toString();</span><br><span class="line">	<span class="comment">// 定时器</span></span><br><span class="line">	Timer timer = <span class="keyword">new</span> Timer(<span class="string">&quot;lock_timer&quot;</span>);</span><br><span class="line"></span><br><span class="line">	<span class="keyword">try</span> &#123;</span><br><span class="line">		Boolean lock = template.opsForValue().setIfAbsent(lockKey, randId, <span class="number">10</span>, TimeUnit.SECONDS);</span><br><span class="line">		<span class="keyword">if</span> (lock != <span class="keyword">null</span> &amp;&amp; !lock) &#123; <span class="comment">// 加锁失败</span></span><br><span class="line">			<span class="keyword">return</span> <span class="string">&quot;error&quot;</span>;</span><br><span class="line">		&#125;</span><br><span class="line">        <span class="comment">// 开始定时器</span></span><br><span class="line">		<span class="keyword">new</span> Thread(()-&gt; timer.schedule(<span class="keyword">new</span> LockTimer(template, lockKey), <span class="number">3000</span>)).start();</span><br><span class="line">		<span class="comment">// doSomething</span></span><br><span class="line">		System.out.println(<span class="string">&quot;doSomething&quot;</span>);</span><br><span class="line">	&#125;<span class="keyword">finally</span> &#123;</span><br><span class="line">		<span class="keyword">if</span> (Objects.equals(template.opsForValue().get(lockKey), randId)) &#123;</span><br><span class="line">			template.delete(lockKey);   <span class="comment">// 删除锁</span></span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">return</span> <span class="string">&quot;success&quot;</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">LockTimer</span> <span class="keyword">extends</span> <span class="title">TimerTask</span> </span>&#123;</span><br><span class="line">	<span class="keyword">private</span> StringRedisTemplate template;</span><br><span class="line">	<span class="keyword">private</span> String key;</span><br><span class="line">	<span class="keyword">private</span> <span class="keyword">int</span> threshold = <span class="number">10</span>;</span><br><span class="line">	<span class="keyword">private</span> <span class="keyword">int</span> delay = <span class="number">1000</span> * threshold / <span class="number">3</span>;</span><br><span class="line"></span><br><span class="line">	LockTimer(StringRedisTemplate template, String key) &#123;</span><br><span class="line">		<span class="keyword">this</span>.template = template;</span><br><span class="line">		<span class="keyword">this</span>.key = key;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="meta">@Override</span></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</span><br><span class="line">		Long time = template.getExpire(key);</span><br><span class="line">		<span class="keyword">if</span> (time !=<span class="keyword">null</span> &amp;&amp; time &lt; delay)</span><br><span class="line">			template.expire(key, threshold * <span class="number">2</span> / <span class="number">3</span>, TimeUnit.SECONDS);</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="基于第三轮演进的案例——秒杀场景下"><a href="#基于第三轮演进的案例——秒杀场景下" class="headerlink" title="基于第三轮演进的案例——秒杀场景下"></a>基于第三轮演进的案例——秒杀场景下</h2><p>基于第三轮的系统架构，可以实现一个分布式情况下简略的秒杀场景；客户端通过nginx做的负载均衡访问到两台tomcat上，两个接口调用第三方Redis实现秒杀情景。  </p>
<p><img src="http://img.marvr.top/upload/images/2020/05/29/72ede1f7-e883-4a15-9614-b17a146dcdfa.png" alt="1590657984140"></p>
<p>在第三轮演进中可以发现，每次进来一个新线程都会去新建一个定时器，为了节省资源，将定时器定为单例，其他代码和第三轮演进类似；(由于已经实现分布式锁，所以每次执行定时器只有一个子线程，所以不需要加锁)  </p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> String LOCK_KEY = <span class="string">&quot;lockKey&quot;</span>;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Value(&quot;$&#123;server.port&#125;&quot;)</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">int</span> port;</span><br><span class="line"></span><br><span class="line"><span class="meta">@RequestMapping(&quot;/&quot;)</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> String <span class="title">main</span><span class="params">()</span> </span>&#123;</span><br><span class="line">	String randId = UUID.randomUUID().toString();</span><br><span class="line">	Integer stock;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">try</span> &#123;</span><br><span class="line">		stock = (Integer) template.opsForValue().get(<span class="string">&quot;stock&quot;</span>);</span><br><span class="line">		<span class="keyword">if</span> (stock != <span class="keyword">null</span> &amp;&amp; stock &lt;= <span class="number">0</span>) &#123;</span><br><span class="line">			<span class="keyword">return</span> <span class="string">&quot;end&quot;</span>;</span><br><span class="line">		&#125;</span><br><span class="line">		Boolean lock = template.opsForValue().setIfAbsent(LOCK_KEY, randId, <span class="number">10</span>, TimeUnit.SECONDS);</span><br><span class="line">		<span class="keyword">if</span> (lock != <span class="keyword">null</span> &amp;&amp; !lock) &#123; <span class="comment">// 加锁失败</span></span><br><span class="line">			<span class="keyword">return</span> <span class="string">&quot;error&quot;</span>;</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="comment">// 开始定时器</span></span><br><span class="line">		<span class="keyword">new</span> Thread(() -&gt; MyTimer.getTimer().schedule(LockTimer.getTimer(template, randId), <span class="number">4000</span>)).start();</span><br><span class="line">		<span class="comment">// doSomething</span></span><br><span class="line">		Long num = template.opsForValue().decrement(<span class="string">&quot;stock&quot;</span>);</span><br><span class="line">		<span class="keyword">if</span> (num != <span class="keyword">null</span>) &#123;</span><br><span class="line">			stock = Math.toIntExact(num);</span><br><span class="line">			System.out.println(port + <span class="string">&quot;\t剩余数量： &quot;</span> + stock);</span><br><span class="line">		&#125;</span><br><span class="line">	&#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">		<span class="keyword">if</span> (Objects.equals(template.opsForValue().get(LOCK_KEY), randId)) &#123;</span><br><span class="line">			template.delete(LOCK_KEY);   <span class="comment">// 删除锁</span></span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">return</span> <span class="string">&quot;success&quot;</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">LockTimer</span> <span class="keyword">extends</span> <span class="title">TimerTask</span> </span>&#123;</span><br><span class="line">	<span class="keyword">private</span> <span class="keyword">static</span> LockTimer lockTimer;</span><br><span class="line">	<span class="keyword">private</span> RedisTemplate&lt;String, Object&gt; template;</span><br><span class="line">	<span class="keyword">private</span> String randId;</span><br><span class="line"></span><br><span class="line">	<span class="function"><span class="keyword">private</span> <span class="title">LockTimer</span><span class="params">(RedisTemplate&lt;String, Object&gt; template, String randId)</span> </span>&#123;</span><br><span class="line">		<span class="keyword">this</span>.randId = randId;</span><br><span class="line">		<span class="keyword">this</span>.template = template;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">static</span> LockTimer <span class="title">getTimer</span><span class="params">(RedisTemplate&lt;String, Object&gt; template, String randId)</span> </span>&#123;</span><br><span class="line">		<span class="keyword">if</span> (lockTimer == <span class="keyword">null</span>) &#123;</span><br><span class="line">			<span class="keyword">return</span> <span class="keyword">new</span> LockTimer(template, randId);</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">return</span> lockTimer;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="meta">@Override</span></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</span><br><span class="line">		String val = (String) template.opsForValue().get(<span class="string">&quot;LOCK_KEY&quot;</span>);</span><br><span class="line">		<span class="keyword">if</span> (randId.equals(val))</span><br><span class="line">			template.expire(LOCK_KEY, <span class="number">10</span>, TimeUnit.SECONDS);</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">MyTimer</span> <span class="keyword">extends</span> <span class="title">Timer</span> </span>&#123;</span><br><span class="line">	<span class="keyword">private</span> <span class="keyword">static</span> MyTimer timer;</span><br><span class="line">	<span class="function"><span class="keyword">private</span> <span class="title">MyTimer</span><span class="params">()</span> </span>&#123;</span><br><span class="line">		<span class="keyword">super</span>();</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">static</span> MyTimer <span class="title">getTimer</span><span class="params">()</span> </span>&#123;</span><br><span class="line">		<span class="keyword">if</span> (timer == <span class="keyword">null</span>) &#123;</span><br><span class="line">			<span class="keyword">return</span> <span class="keyword">new</span> MyTimer();</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">return</span> timer;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>然后给Redis设置初值；开启nginx；启动8080端口、8081端口；开启jmeter压测；在控制台查看报告  </p>
<p>Redis：  </p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">127.0.0.1:6379&gt; set stock 100  </span><br><span class="line">OK  </span><br><span class="line">127.0.0.1:6379&gt; get stock  </span><br><span class="line">&quot;100&quot;  </span><br></pre></td></tr></table></figure>
<p>nginx：  </p>
<figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">upstream tomcats &#123;  </span><br><span class="line">	server 127.0.0.1:8080;  </span><br><span class="line">	server 127.0.0.1:8081;  </span><br><span class="line">&#125;  </span><br><span class="line">server &#123;  </span><br><span class="line">	location / &#123;  </span><br><span class="line">		proxy_pass http://tomcats;  </span><br><span class="line">	&#125;  </span><br><span class="line">    # 省略其他配置...  </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li>启动8080\8081服务  </li>
<li>jmeter设置线程组压测(200个线程、时间间隔0秒、发四组)  </li>
</ul>
<p>查看控制台输出  </p>
<figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">8080	剩余数量： 98</span><br><span class="line">8080	剩余数量： 97</span><br><span class="line"># 省略部分输出...</span><br><span class="line">8080	剩余数量： 60</span><br><span class="line">8080	剩余数量： 58</span><br><span class="line">8080	剩余数量： 55</span><br><span class="line">8080	剩余数量： 54</span><br></pre></td></tr></table></figure>
<figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">8081	剩余数量： 99</span><br><span class="line">8081	剩余数量： 96</span><br><span class="line"># 省略部分输出...</span><br><span class="line">8081	剩余数量： 59</span><br><span class="line">8081	剩余数量： 57</span><br><span class="line">8081	剩余数量： 56</span><br></pre></td></tr></table></figure>
<p>可以发现两个tomcat一共接受800个线程请求，由于加锁大部分请求被挡在外面，发生了少买的情况。并且在同一时间并发数越高的情况下，请求被打回的情况越多。那么如何改进呢？我们可以借助锁升级过程中的一个思想，如果没有拿到锁就自旋，自选10次还是拿不到锁就退出。  </p>
<p>代码实现也比较简单，只需要将上面的判断库存的过程和获取锁的过程放在while循环中即可：  </p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">Boolean lock = <span class="keyword">false</span>;</span><br><span class="line"><span class="keyword">int</span> count = <span class="number">10</span>;</span><br><span class="line"><span class="keyword">while</span> (lock != <span class="keyword">null</span> &amp;&amp; !lock) &#123; <span class="comment">// 加锁失败</span></span><br><span class="line">	stock = (Integer) template.opsForValue().get(<span class="string">&quot;stock&quot;</span>);</span><br><span class="line">	<span class="keyword">if</span> (stock != <span class="keyword">null</span> &amp;&amp; stock &lt;= <span class="number">0</span>) &#123;</span><br><span class="line">		System.out.println(<span class="string">&quot;卖完了！！！&quot;</span>);</span><br><span class="line">		<span class="keyword">return</span> <span class="string">&quot;end&quot;</span>;</span><br><span class="line">	&#125;</span><br><span class="line">	lock = template.opsForValue().setIfAbsent(LOCK_KEY, randId, <span class="number">10</span>, TimeUnit.SECONDS);</span><br><span class="line">	<span class="keyword">if</span> (lock != <span class="keyword">null</span> &amp;&amp; !lock) &#123; <span class="comment">// 加锁失败</span></span><br><span class="line">		<span class="keyword">if</span> (count-- &lt;= <span class="number">0</span>)</span><br><span class="line">			<span class="keyword">return</span> <span class="string">&quot;网络繁忙,请稍后再试&quot;</span>;</span><br><span class="line">		Thread.sleep(<span class="number">20</span>);</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>同样采用上面的配置进行压测就可以看到200*4个请求的利用率大幅提高  </p>
<figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">8080	剩余数量： 99</span><br><span class="line">8080	剩余数量： 95</span><br><span class="line"># 省略部分输出...</span><br><span class="line">8080	剩余数量： 3</span><br><span class="line">8080	剩余数量： 2</span><br><span class="line">卖完了！！！</span><br><span class="line">卖完了！！！</span><br><span class="line"># ....</span><br><span class="line"># 8080端口共处理202个请求</span><br></pre></td></tr></table></figure>
<figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">8081	剩余数量： 98</span><br><span class="line">8081	剩余数量： 97</span><br><span class="line"># 省略部分输出...</span><br><span class="line">8081	剩余数量： 5</span><br><span class="line">8081	剩余数量： 1</span><br><span class="line">8081	剩余数量： 0</span><br><span class="line">卖完了！！！</span><br><span class="line">卖完了！！！</span><br><span class="line">卖完了！！！</span><br><span class="line"># ...</span><br><span class="line"># 8081端口共处理212个请求</span><br></pre></td></tr></table></figure>
<blockquote>
<p>可根据实际情况具体调节自旋间隔时间和自旋次数  </p>
<p>在并发高库存量少的情况下不需要使用自旋，通常不会出现少买的情况  </p>
<p>并发低库存量大的情况下可以取消自旋次数  </p>
</blockquote>
<h2 id="redisson分布式锁的使用"><a href="#redisson分布式锁的使用" class="headerlink" title="redisson分布式锁的使用"></a>redisson分布式锁的使用</h2><h3 id="什么是redisson"><a href="#什么是redisson" class="headerlink" title="什么是redisson"></a>什么是redisson</h3><blockquote>
<p>摘自<a target="_blank" rel="noopener" href="https://redis.io/topics/distlock">redis</a>官网介绍：  </p>
<p>Redis提供一种更规范的算法来实现Redis的分布式锁，提出了一种称为<strong>Redlock</strong>的算法，该算法实现了DLM( 分布式锁管理器)，我们认为它比普通的单实例方法更安全。  </p>
<p>而Redisson是基于Redlock算法的Java语言实现  </p>
</blockquote>
<h3 id="Redlock算法官方介绍"><a href="#Redlock算法官方介绍" class="headerlink" title="Redlock算法官方介绍"></a>Redlock算法官方介绍</h3><blockquote>
<p>In the distributed version of the algorithm we assume we have N Redis masters. Those nodes are totally independent, so we don’t use replication or any other implicit coordination system. We already described how to acquire and release the lock safely in a single instance. We take for granted that the algorithm will use this method to acquire and release the lock in a single instance. In our examples we set N=5, which is a reasonable value, so we need to run 5 Redis masters on different computers or virtual machines in order to ensure that they’ll fail in a mostly independent way.  </p>
<p>In order to acquire the lock, the client performs the following operations:  </p>
<ol>
<li>It gets the current time in milliseconds.  </li>
<li>It tries to acquire the lock in all the N instances sequentially, using the same key name and random value in all the instances. During step 2, when setting the lock in each instance, the client uses a timeout which is small compared to the total lock auto-release time in order to acquire it. For example if the auto-release time is 10 seconds, the timeout could be in the ~ 5-50 milliseconds range. This prevents the client from remaining blocked for a long time trying to talk with a Redis node which is down: if an instance is not available, we should try to talk with the next instance ASAP.  </li>
<li>The client computes how much time elapsed in order to acquire the lock, by subtracting from the current time the timestamp obtained in step 1. If and only if the client was able to acquire the lock in the majority of the instances (at least 3), and the total time elapsed to acquire the lock is less than lock validity time, the lock is considered to be acquired.  </li>
<li>If the lock was acquired, its validity time is considered to be the initial validity time minus the time elapsed, as computed in step 3.  </li>
<li>If the client failed to acquire the lock for some reason (either it was not able to lock N/2+1 instances or the validity time is negative), it will try to unlock all the instances (even the instances it believed it was not able to lock).  </li>
</ol>
</blockquote>
<p>在算法的分布式版本中，我们假设我们有N个Redis主节点。这些节点是完全独立的，因此我们不使用复制或任何其他隐式协调系统。我们已经描述了如何在单个实例中安全地获取和释放锁。我们认为该算法将使用此方法在单个实例中获取和释放锁，这是理所当然的。在我们的示例中，我们将N = 5设置为一个合理的值，因此我们需要在不同的计算机或虚拟机上运行5个Redis主服务器，以确保它们将以大多数独立的方式发生故障。  </p>
<p>为了获取锁，客户端执行以下操作：  </p>
<ol>
<li>它以毫秒为单位获取当前时间。  </li>
<li>它尝试在所有N个实例中顺序使用所有实例中相同的键名和随机值来获取锁定。在第2步中，在每个实例中设置锁定时，客户端使用的超时时间小于总锁定自动释放时间，以便获取该超时时间。例如，如果自动释放时间为10秒，则超时时间可能在5到50毫秒之间。这样可以防止客户端长时间与处于故障状态的Redis节点进行通信：如果某个实例不可用，我们应该尝试与下一个实例尽快进行通信。  </li>
<li>客户端通过从当前时间中减去在步骤1中获得的时间戳，来计算获取锁所花费的时间。当且仅当客户端能够在大多数实例（至少3个）中获取锁时， ，并且获取锁所花费的总时间小于锁有效时间，则认为已获取锁。  </li>
<li>如果获取了锁，则将其有效时间视为初始有效时间减去经过的时间，如步骤3中所计算。  </li>
<li>如果客户端由于某种原因（无法锁定N / 2 + 1个实例或有效时间为负）而未能获得该锁，它将尝试解锁所有实例（即使它认为不是该实例）能够锁定）。  </li>
</ol>
<blockquote>
<p>后面会单独撕Redisson源码，这里的Redlock算法很重要，理解这块可以帮助理解Redisson源码</p>
</blockquote>
<h3 id="Redisson使用"><a href="#Redisson使用" class="headerlink" title="Redisson使用"></a>Redisson使用</h3><p><a target="_blank" rel="noopener" href="https://github.com/redisson/redisson">redisson</a>的github上有较为详细的使用方式</p>
<ol>
<li>导入maven</li>
</ol>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.redisson<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>redisson<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">version</span>&gt;</span>3.8.1<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>
<ol start="2">
<li>使用</li>
</ol>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Bean</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> Redisson <span class="title">redisson</span><span class="params">()</span></span>&#123;</span><br><span class="line">	Config config = <span class="keyword">new</span> Config();</span><br><span class="line">	config.useSingleServer()</span><br><span class="line">			.setAddress(<span class="string">&quot;redis://192.168.5.129:6379&quot;</span>)</span><br><span class="line">			.setPassword(<span class="string">&quot;password&quot;</span>)</span><br><span class="line">			.setDatabase(<span class="number">0</span>);</span><br><span class="line">	<span class="keyword">return</span> (Redisson) Redisson.create(config);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// -------------------------------</span></span><br><span class="line"><span class="meta">@Resource</span></span><br><span class="line"><span class="keyword">private</span> Redisson redisson;</span><br><span class="line"><span class="function"><span class="keyword">public</span> String <span class="title">redisson</span><span class="params">()</span> </span>&#123;</span><br><span class="line">	RLock rLock = redisson.getLock(LOCK_KEY);</span><br><span class="line">	<span class="keyword">boolean</span> locked = <span class="keyword">false</span>;</span><br><span class="line">	<span class="keyword">try</span> &#123;</span><br><span class="line">		<span class="keyword">if</span> (locked = rLock.tryLock(<span class="number">5</span>, TimeUnit.SECONDS)) &#123;</span><br><span class="line">			<span class="comment">// do something</span></span><br><span class="line">			<span class="keyword">return</span> <span class="string">&quot;success&quot;</span>;</span><br><span class="line">		&#125;</span><br><span class="line">	&#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">		e.printStackTrace();</span><br><span class="line">	&#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">		<span class="keyword">if</span> (locked) &#123;</span><br><span class="line">			rLock.unlock();</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">return</span> <span class="string">&quot;网络繁忙,稍后再试&quot;</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h2><h3 id="Redisson分布式锁的整体思路及问题"><a href="#Redisson分布式锁的整体思路及问题" class="headerlink" title="Redisson分布式锁的整体思路及问题"></a>Redisson分布式锁的整体思路及问题</h3><p><img src="http://img.marvr.top/upload/images/2020/05/29/5c7106f7-1b8d-44bd-9a6d-4457abe631bd.png" alt="1590741960844"></p>
<p>当客户端访问带redisson时，redisson先去尝试加锁，如果加锁不成功就自旋，如果加锁成功就会开启一个后台线程，每隔10秒检测该线程是否还持有锁，如果还持久就要对锁进行续期。  </p>
<p>但由于Redis是有个弱一致性架构，master会先返回结果，再进行同步(官网中称异步)。当master结点获得锁后宕机，此时从结点替代主节点，然而从节点中未能及时同步master的锁信息，而导致锁条件被破坏。然而官方提供了一个最终一致性的解决方案(尚未实现)，具体内容可以参照博文——<a target="_blank" rel="noopener" href="http://marvr.top/blog/29">Redis学习之路(四)——Redis持久化理念</a>  </p>
<blockquote>
<p>摘自 <a target="_blank" rel="noopener" href="https://redis.io/topics/distlock">https://redis.io/topics/distlock</a> (Why failover-based implementations are not enough)  </p>
<p>The simplest way to use Redis to lock a resource is to create a key in an instance. The key is usually created with a limited time to live, using the Redis expires feature, so that eventually it will get released (property 2 in our list). When the client needs to release the resource, it deletes the key.  </p>
<p>使用Redis锁定资源的最简单方法是在实例中创建密钥。使用Redis过期功能，通常会在有限的生存时间内创建密钥，以便最终将其释放（我们列表中的属性2）。当客户端需要释放资源时，它将删除密钥。  </p>
<p>Superficially this works well, but there is a problem: this is a single point of failure in our architecture. What happens if the Redis master goes down? Well, let’s add a slave! And use it if the master is unavailable. This is unfortunately not viable. By doing so we can’t implement our safety property of mutual exclusion, because Redis replication is asynchronous.  </p>
<p>从表面上看，这很好，但是存在一个问题：这是我们架构中的单点故障。如果Redis主服务器宕机了怎么办？好吧，让我们添加一个奴隶！如果主服务器不可用，请使用它。不幸的是，这是不可行的。这样，我们就无法实现互斥的安全属性，因为<strong>Redis复制是异步</strong>的。  </p>
<p>There is an obvious race condition with this model:  </p>
<ol>
<li>Client A acquires the lock in the master.  </li>
<li>The master crashes before the write to the key is transmitted to the slave.  </li>
<li>The slave gets promoted to master.  </li>
<li>Client B acquires the lock to the same resource A already holds a lock for. <strong>SAFETY VIOLATION!</strong>  </li>
</ol>
<p>此模型有一个明显的竞争条件：  </p>
<ol>
<li>客户端A获取主服务器中的锁。  </li>
<li>在将密钥写入传输到从机之前，主机崩溃。  </li>
<li>奴隶晋升为主人。  </li>
<li>客户端B获取对相同资源A的锁定，而该资源A已经为其持有了锁定。<strong>安全违规！</strong>  </li>
</ol>
<p>Sometimes it is perfectly fine that under special circumstances, like during a failure, multiple clients can hold the lock at the same time. If this is the case, you can use your replication based solution. Otherwise we suggest to implement the solution described in this document.  </p>
<p>有时候，在特殊情况下（例如在故障期间），多个客户端可以同时持有锁是完全可以的。在这种情况下，您可以使用基于复制的解决方案。  </p>
</blockquote>
<p><img src="http://img.marvr.top/upload/images/2020/05/29/4147c667-97c2-4849-b3c3-8d19064ef5ce.png" alt="1590743204250"></p>
<p>由于暂时没有Redis的最终一致性的实现，所以如果必须解决整个问题建议采用zookeeper  </p>
<h3 id="如何提高Redis分布式锁的性能"><a href="#如何提高Redis分布式锁的性能" class="headerlink" title="如何提高Redis分布式锁的性能"></a>如何提高Redis分布式锁的性能</h3><ol>
<li><p>Redis本身是内存数据库，而且采用多路复用的IO模型，一般来说性能瓶颈不会出现在Redis端  </p>
</li>
<li><p>减小锁粒度。尽可能的减少锁持有的时间  </p>
</li>
<li><p>lua脚本。尽可能采用一次服务通信  </p>
</li>
</ol>

      
    </div>
    <div class="article-footer">
      <blockquote class="mt-2x">
  <ul class="post-copyright list-unstyled">
    
    <li class="post-copyright-link hidden-xs">
      <strong>本文链接：</strong>
      <a href="https://rabbit-mar.github.io/2020/05/29/%E5%9F%BA%E4%BA%8ERedis%E5%88%86%E5%B8%83%E5%BC%8F%E9%94%81%E7%9A%84%E6%BC%94%E5%8F%98%E5%8F%8A%E5%AE%9E%E7%8E%B0/" title="基于Redis分布式锁的演变及实现" target="_blank" rel="external">https://rabbit-mar.github.io/2020/05/29/%E5%9F%BA%E4%BA%8ERedis%E5%88%86%E5%B8%83%E5%BC%8F%E9%94%81%E7%9A%84%E6%BC%94%E5%8F%98%E5%8F%8A%E5%AE%9E%E7%8E%B0/</a>
    </li>
    
    <li class="post-copyright-license">
      <strong>版权声明： </strong> 本博客所有文章除特别声明外，均采用 <a href="http://creativecommons.org/licenses/by/4.0/deed.zh" target="_blank" rel="external">CC BY 4.0 CN协议</a> 许可协议。转载请注明出处！
    </li>
  </ul>
</blockquote>


<div class="panel panel-default panel-badger">
  <div class="panel-body">
    <figure class="media">
      <div class="media-left">
        <a href="https://github.com/Rabbit-Mar" target="_blank" class="img-burn thumb-sm visible-lg">
          <img src="/images/avatar.jpg" class="img-rounded w-full" alt="">
        </a>
      </div>
      <div class="media-body">
        <h3 class="media-heading"><a href="https://github.com/Rabbit-Mar" target="_blank"><span class="text-dark">Marveal Rabbit</span><small class="ml-1x">Programming Lover &amp; Coder</small></a></h3>
        <div>热爱学习，探索新事物，对技术抱有追求；热爱挑战，不惧困难，精致人生；</div>
      </div>
    </figure>
  </div>
</div>


    </div>
  </article>
  
  
  <section id="comments">
  	
    
  </section>


  
</div>
</main>

  <footer class="footer" itemscope itemtype="http://schema.org/WPFooter">
	
	
    <ul class="social-links">
    	
        <li><a href="https://github.com/Rabbit-Mar" target="_blank" title="Github" data-toggle=tooltip data-placement=top><i class="icon icon-github"></i></a></li>
        
        <li><a href="https://gitee.com/marveal_admin" target="_blank" title="Gitee" data-toggle=tooltip data-placement=top><i class="icon icon-gitee"></i></a></li>
        
        <li><a href="https://blog.csdn.net/weixin_43260474" target="_blank" title="Code" data-toggle=tooltip data-placement=top><i class="icon icon-code"></i></a></li>
        
        <li><a href="/atom.xml" target="_blank" title="Rss" data-toggle=tooltip data-placement=top><i class="icon icon-rss"></i></a></li>
        
    </ul>

    <div class="copyright">
    	
        <div class="publishby">
        	Theme by <a href="https://github.com/cofess" target="_blank"> cofess </a>base on <a href="https://github.com/cofess/hexo-theme-pure" target="_blank">pure</a>.
        </div>
    </div>
</footer>
  <script src="//cdn.jsdelivr.net/npm/jquery@1.12.4/dist/jquery.min.js"></script>
<script>
window.jQuery || document.write('<script src="js/jquery.min.js"><\/script>')
</script>

<script src="/js/plugin.min.js"></script>


<script src="/js/application.js"></script>


    <script>
    (function (window) {
        var INSIGHT_CONFIG = {
            TRANSLATION: {
                POSTS: '文章',
                PAGES: '页面',
                TAGS: '标签',
                UNTITLED: '(未命名)',
            },
            ROOT_URL: '/',
            CONTENT_URL: '/content.json',
        };
        window.INSIGHT_CONFIG = INSIGHT_CONFIG;
    })(window);
</script>

<script src="/js/insight.js"></script>




   
<script async src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>



   
    
<link rel="stylesheet" href="https://imsun.github.io/gitment/style/default.css">
<script src="https://imsun.github.io/gitment/dist/gitment.browser.js"></script>
<script>
  var gitment = new Gitment({
    id: '基于Redis分布式锁的演变及实现',
    owner: 'Rabbit-Mar', // 可以是你的GitHub用户名，也可以是github id
    repo: 'rabbit-mar.github.io',
    oauth: {
      client_id: 'a05c4d867ec26c0a59d2',
      client_secret: '0bdcf90d06734d19c37969511ddc20e0835dbd0a',
    }
  })
  gitment.render('comments')
</script>








</body>
</html>